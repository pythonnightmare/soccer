<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Street Football — Fixed Build</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div id="hud">
    <div class="scoreboard">
      <span id="homeName">HOME</span>
      <span id="homeScore">0</span>
      <span class="divider">:</span>
      <span id="awayScore">0</span>
      <span id="awayName">AWAY</span>
    </div>
    <div id="goalBanner" class="banner hidden">GOAL!</div>
    <div id="info" class="panel">
      <div>조작: 이동 WASD / 조준 ←↑→↓ / 패스 X / 슛 Z / 선수전환(방향기+Q) / 대시 Shift</div>
      <div>커스터마이즈(미페·UI): C / 디버그: F1 / 일시정지: P</div>
    </div>
  </div>

  <canvas id="game" width="1280" height="720"></canvas>

  <!-- 미니맵 -->
  <canvas id="minimap" width="256" height="128"></canvas>

  <!-- 강화(커스터마이즈) 모달 -->
  <div id="customizeModal" class="modal hidden" aria-hidden="true">
    <div class="modal-inner">
      <div class="modal-header">
        <h3>강화창 — 선수 미페 & UI 스킨</h3>
        <button id="closeCustomize" class="btn ghost">닫기</button>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="avatars">미페</button>
        <button class="tab" data-tab="skins">UI 스킨</button>
      </div>
      <div class="tabpanes">
        <div class="tabpane active" id="tab-avatars">
          <div class="avatar-grid" id="avatarGrid">
            <!-- JS에서 8종 생성 -->
          </div>
          <div class="current-player">
            <canvas id="avatarPreview" width="96" height="96"></canvas>
            <div>
              <div id="currentPlayerLabel">선수: -</div>
              <button id="applyAvatar" class="btn primary">적용</button>
            </div>
          </div>
        </div>
        <div class="tabpane" id="tab-skins">
          <div class="skin-grid">
            <button class="skin-card" data-skin="card">카드형</button>
            <button class="skin-card" data-skin="neon">네온형</button>
            <button class="skin-card" data-skin="minimal">미니멀</button>
          </div>
          <div class="tip">스킨은 HUD/배너/강화창에 즉시 적용됩니다.</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { Game } from './game.js';
    import { buildAllAvatarOptions, drawAvatarOn } from './assets.js';

    const canvas = document.getElementById('game');
    const minimap = document.getElementById('minimap');
    const game = new Game(canvas, minimap, {
      speedScale: 1.4,          // 전역 속도 +40%
      fieldWidthScale: 2.0      // 경기장 폭 2배
    });

    // 스코어/배너 바인딩
    const homeScore = document.getElementById('homeScore');
    const awayScore = document.getElementById('awayScore');
    const banner = document.getElementById('goalBanner');
    game.onScore((home, away) => {
      homeScore.textContent = home;
      awayScore.textContent = away;
      banner.classList.remove('hidden');
      banner.classList.add('show');
      setTimeout(() => banner.classList.remove('show'), 1200);
      setTimeout(() => banner.classList.add('hidden'), 1600);
    });

    // 커스터마이즈(UI/미페)
    const modal = document.getElementById('customizeModal');
    const closeBtn = document.getElementById('closeCustomize');
    const avatarGrid = document.getElementById('avatarGrid');
    const avatarPreview = document.getElementById('avatarPreview');
    const currentLabel = document.getElementById('currentPlayerLabel');
    const applyAvatar = document.getElementById('applyAvatar');

    const tabs = [...document.querySelectorAll('.tab')];
    const panes = {
      avatars: document.getElementById('tab-avatars'),
      skins: document.getElementById('tab-skins')
    };

    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      panes.avatars.classList.toggle('active', t.dataset.tab === 'avatars');
      panes.skins.classList.toggle('active', t.dataset.tab === 'skins');
    }));

    closeBtn.onclick = () => modal.classList.add('hidden');

    // 열기: C
    window.addEventListener('keydown', (e) => {
      if (e.code === 'KeyC') {
        modal.classList.toggle('hidden');
        if (!modal.classList.contains('hidden')) {
          refreshAvatarGrid();
          previewCurrent();
        }
      }
    });

    function refreshAvatarGrid() {
      avatarGrid.innerHTML = '';
      const options = buildAllAvatarOptions();
      options.forEach(opt => {
        const c = document.createElement('canvas');
        c.width = 64; c.height = 64;
        drawAvatarOn(c.getContext('2d'), opt.type, 32, 32, 28);
        c.className = 'avatar';
        c.title = opt.label;
        c.dataset.type = opt.type;
        c.addEventListener('click', () => {
          document.querySelectorAll('.avatar.selected').forEach(n => n.classList.remove('selected'));
          c.classList.add('selected');
          drawAvatarOn(avatarPreview.getContext('2d'), opt.type, 48, 48, 44, true);
          avatarPreview.dataset.sel = opt.type;
        });
        avatarGrid.appendChild(c);
      });
    }

    function previewCurrent() {
      const sel = game.getSelectedPlayer();
      currentLabel.textContent = `선수: ${sel?.name ?? '-'}`;
      const t = sel?.avatarType ?? 'poodle';
      drawAvatarOn(avatarPreview.getContext('2d'), t, 48, 48, 44, true);
      avatarPreview.dataset.sel = t;
    }

    applyAvatar.onclick = () => {
      const type = avatarPreview.dataset.sel || 'poodle';
      const p = game.getSelectedPlayer();
      if (p) {
        p.avatarType = type;
      }
    };

    // 스킨
    document.querySelectorAll('.skin-card').forEach(btn => {
      btn.addEventListener('click', () => {
        document.body.dataset.skin = btn.dataset.skin;
      });
    });

    // 루프 시작
    game.start();
  </script>
</body>
</html>
